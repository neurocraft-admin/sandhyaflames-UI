<!-- src/app/views/daily-delivery/daily-delivery.component.html -->
<div class="container mt-3">
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">Daily Delivery Entry</h5>

      <form [formGroup]="form" (ngSubmit)="submit()">
        <!-- ===== Header Fields ===== -->
        <div class="row mb-3">
          <!-- Date -->
          <div class="col-md-3">
            <label for="deliveryDate" class="form-label">Date</label>
            <input id="deliveryDate" type="date" class="form-control" formControlName="deliveryDate" />
          </div>

          <!-- Driver -->
          <div class="col-md-3">
            <label for="driverSelect" class="form-label">Driver</label>

            <!-- Assigned driver label (shows the assigned driver) -->
            <div style="font-weight: bold; color: #0d6efd; margin-bottom: 3px;">
              Assigned Driver: {{ assignedDriverName || 'None' }}
            </div>

            <select id="driverSelect" class="form-select" formControlName="driverId" (change)="onDriverChange()">
              <option [ngValue]="0">-- Select Driver --</option>
              <option *ngFor="let d of drivers" [ngValue]="d.driverId">
                {{ d.driverName }}
              </option>
            </select>
          </div>

          <!-- Vehicle -->
          <div class="col-md-4">
            <label for="vehicleSelect" class="form-label">Vehicle</label>

            <!-- Assigned vehicle label (shows the default/assigned vehicle) -->
            <div style="font-weight: bold; color: #0d6efd; margin-bottom: 3px;">
              Assigned Vehicle: {{ assignedVehicleNumber || 'None' }}
            </div>

            <select id="vehicleSelect" class="form-select" formControlName="vehicleId">
              <option [ngValue]="0">-- Select Vehicle --</option>
              <option *ngFor="let v of vehicles" [ngValue]="v.vehicleId">
                {{ v.vehicleNumber }}
              </option>
            </select>
          </div>
        </div>

        <!-- ===== Time & Remarks ===== -->
        <div class="row mb-3">
          <!-- Start Time -->
          <div class="col-md-3">
            <label for="startTime" class="form-label">Start Time</label>
            <input id="startTime" type="time" class="form-control" formControlName="startTime" />
          </div>

          <!-- Return Time -->
          <div class="col-md-3">
            <label for="returnTime" class="form-label">Return Time</label>
            <input id="returnTime" type="time" class="form-control" formControlName="returnTime" />
          </div>

          <!-- Remarks -->
          <div class="col-md-6">
            <label for="remarks" class="form-label">Remarks</label>
            <input id="remarks" type="text" class="form-control" formControlName="remarks"
              placeholder="Optional remarks..." />
          </div>

          <!-- Has Credit Customers -->
          <div class="col-md-3 d-flex align-items-center pt-4">
            <input class="form-check-input me-2" type="checkbox" formControlName="hasCreditCustomers" id="creditCustomersChk" />
            <label class="form-check-label" for="creditCustomersChk">
              <strong>Has Credit Customers</strong>
            </label>
          </div>
        </div>

        <!-- ===== Product Items ===== -->
        <div formArrayName="items">
          <h6 class="mt-3">Products</h6>
          <div *ngFor="let item of items.controls; let i = index" [formGroupName]="i" class="row mb-2 align-items-end">
            <!-- Product -->
            <div class="col-md-4">
              <label class="form-label">Product</label>
              <select class="form-select" formControlName="productId" (change)="onProductSelect(item, $event)">
                <option value="0">-- Select Product --</option>
                <option *ngFor="let p of products" [value]="p.productId">
                  {{ p.productName }}
                </option>
              </select>
            </div>

            <!-- Cylinders -->
            <div class="col-md-2">
              <label class="form-label">Cylinders</label>
              <input type="number" class="form-control" formControlName="noOfCylinders" />
            </div>

            <!-- Invoices -->
            <div class="col-md-2">
              <label class="form-label">Invoices</label>
              <input type="number" class="form-control" formControlName="noOfInvoices" />
            </div>

            <!-- Items -->
            <div class="col-md-2">
              <label class="form-label">Items</label>
              <input type="number" class="form-control" formControlName="noOfItems" />
            </div>
          </div>

          <button *ngIf="permissions.canCreate" type="button" class="btn btn-sm btn-secondary mt-2" (click)="addItemRow()">
            + Add Item
          </button>
        </div>

        <!-- ===== Save Button ===== -->
        <div *ngIf="permissions.canCreate" class="mt-4 text-end">
          <button type="submit" class="btn btn-primary">
            Save Delivery
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Existing Deliveries Table ===== -->
  <div class="card mt-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">Existing Deliveries</h5>
      
      <!-- Filter Controls -->
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="fromDate" class="form-label">From Date</label>
          <input id="fromDate" type="date" class="form-control" [(ngModel)]="fromDate" />
        </div>
        <div class="col-md-3">
          <label for="toDate" class="form-label">To Date</label>
          <input id="toDate" type="date" class="form-control" [(ngModel)]="toDate" />
        </div>
        <div class="col-md-2">
          <label for="filterStatus" class="form-label">Status</label>
          <select id="filterStatus" class="form-select" [(ngModel)]="filterStatus">
            <option value="All">All</option>
            <option value="Open">Open</option>
            <option value="Closed">Closed</option>
          </select>
        </div>
        <div class="col-md-4 d-flex align-items-end gap-2">
          <button class="btn btn-primary" (click)="applyFilters()">
            <i class="icon icon-search me-1"></i>Search
          </button>
          <button class="btn btn-secondary" (click)="clearFilters()">Clear</button>
          <small class="text-muted ms-auto align-self-center">{{ paginatedDeliveries.length }} of {{ filteredDeliveries.length }}</small>
        </div>
      </div>

      <table class="table table-bordered table-striped table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Driver</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of paginatedDeliveries">
            <td>{{ d.DeliveryDate | date: 'dd-MM-yyyy' }}</td>
            <td>{{ d.DriverName || '-' }}</td>
            <td>
              <span class="badge" [class.bg-success]="d.Status === 'Closed'" [class.bg-warning]="d.Status === 'Open'">
                {{ d.Status }}
              </span>
            </td>
            <td>
              <button *ngIf="permissions.canUpdate" class="btn btn-info btn-sm me-1" (click)="recompute(d.DeliveryId)"
                title="Recalculate planned items from delivery items (use after editing items or to populate initial metrics)">
                Recompute
              </button>
              <button *ngIf="permissions.canUpdate" class="btn btn-success btn-sm me-1" (click)="closeDelivery(d.DeliveryId)"
                [disabled]="d.Status === 'Closed'">
                Close
              </button>
              <button *ngIf="permissions.canUpdate" class="btn btn-warning btn-sm" [routerLink]="['/DailyDeliveryUpdate', d.DeliveryId]">
                Update
              </button>
            </td>
          </tr>
          <tr *ngIf="!paginatedDeliveries || paginatedDeliveries.length === 0">
            <td colspan="4" class="text-center text-muted">
              No deliveries found for selected filters.
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination Controls -->
      <div class="d-flex justify-content-between align-items-center" *ngIf="totalPages > 1">
        <div>
          <button class="btn btn-sm btn-outline-primary me-1" (click)="goToPage(1)" [disabled]="currentPage === 1">
            First
          </button>
          <button class="btn btn-sm btn-outline-primary me-1" (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">
            Previous
          </button>
          <span class="mx-2">Page {{ currentPage }} of {{ totalPages }}</span>
          <button class="btn btn-sm btn-outline-primary me-1" (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">
            Next
          </button>
          <button class="btn btn-sm btn-outline-primary" (click)="goToPage(totalPages)" [disabled]="currentPage === totalPages">
            Last
          </button>
        </div>
        <div>
          <select class="form-select form-select-sm" [(ngModel)]="pageSize" (change)="applyFilters()" style="width: auto; display: inline-block;">
            <option [value]="5">5 per page</option>
            <option [value]="10">10 per page</option>
            <option [value]="25">25 per page</option>
            <option [value]="50">50 per page</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>