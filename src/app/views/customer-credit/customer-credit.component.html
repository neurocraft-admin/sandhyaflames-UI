<div class="container-fluid">
  <div class="mb-3 d-flex justify-content-between align-items-center">
    <h4>Customer Credit Management</h4>
    <div>
      <button cButton color="success" (click)="openPaymentForm()" class="me-2">Record Payment</button>
      <button cButton color="primary" (click)="openCreditForm()">Set Credit Limit</button>
    </div>
  </div>

  <!-- Credits Overview Table -->
  <div class="card mb-4">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead>
            <tr>
              <th>Customer Name</th>
              <th class="text-end">Credit Limit</th>
              <th class="text-end">Credit Used</th>
              <th class="text-end">Available</th>
              <th class="text-end">Outstanding</th>
              <th class="text-end">Total Paid</th>
              <th>Last Payment</th>
              <th>Status</th>
              <th style="width:100px">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of credits">
              <td>{{ c.customerName }}</td>
              <td class="text-end">{{ c.creditLimit | currency: 'INR' }}</td>
              <td class="text-end">{{ c.creditUsed | currency: 'INR' }}</td>
              <td class="text-end">
                <span [class.text-success]="c.creditAvailable > 0" [class.text-danger]="c.creditAvailable <= 0">
                  {{ c.creditAvailable | currency: 'INR' }}
                </span>
              </td>
              <td class="text-end">
                <span [class.text-danger]="c.outstandingAmount > 0">
                  {{ c.outstandingAmount | currency: 'INR' }}
                </span>
              </td>
              <td class="text-end">{{ c.totalPaid | currency: 'INR' }}</td>
              <td>
                <div *ngIf="c.lastPaymentDate">
                  {{ c.lastPaymentDate | date: 'dd-MM-yyyy' }}<br>
                  <small class="text-muted">{{ c.lastPaymentAmount | currency: 'INR' }}</small>
                </div>
                <span *ngIf="!c.lastPaymentDate" class="text-muted">-</span>
              </td>
              <td>
                <span class="badge" [class.bg-success]="c.isActive" [class.bg-secondary]="!c.isActive">
                  {{ c.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td>
                <button cButton size="sm" color="info" (click)="viewTransactions(c.customerId)">
                  History
                </button>
              </td>
            </tr>
            <tr *ngIf="credits.length === 0">
              <td colspan="9" class="text-center text-muted">No credit records found</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Set Credit Limit Form -->
  <div class="card mb-4" *ngIf="showCreditForm()">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Set Credit Limit</strong>
      <button cButton size="sm" color="secondary" (click)="cancelCreditForm()">✕</button>
    </div>
    <div class="card-body">
      <form [formGroup]="creditForm" (ngSubmit)="submitCredit()">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Customer *</label>
            <select class="form-select" formControlName="customerId">
              <option [ngValue]="0">-- Select Customer --</option>
              <option *ngFor="let c of customers" [ngValue]="c.customerId">
                {{ c.customerName }}
              </option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Credit Limit *</label>
            <input type="number" class="form-control" formControlName="creditLimit" placeholder="Enter credit limit" />
          </div>

          <div class="col-md-4 d-flex align-items-center">
            <input class="form-check-input me-2" type="checkbox" formControlName="isActive" id="creditActiveChk" />
            <label class="form-check-label" for="creditActiveChk">Active</label>
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button cButton color="primary" type="submit" [disabled]="creditForm.invalid || loading()">
            {{ loading() ? 'Saving...' : 'Save Credit Limit' }}
          </button>
          <button cButton color="secondary" type="button" (click)="cancelCreditForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Record Payment Form -->
  <div class="card mb-4" *ngIf="showPaymentForm()">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Record Payment</strong>
      <button cButton size="sm" color="secondary" (click)="cancelPaymentForm()">✕</button>
    </div>
    <div class="card-body">
      <form [formGroup]="paymentForm" (ngSubmit)="submitPayment()">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Customer *</label>
            <select class="form-select" formControlName="customerId">
              <option [ngValue]="0">-- Select Customer --</option>
              <option *ngFor="let c of customers" [ngValue]="c.customerId">
                {{ c.customerName }}
              </option>
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">Payment Amount *</label>
            <input type="number" class="form-control" formControlName="paymentAmount" placeholder="Amount" />
          </div>

          <div class="col-md-2">
            <label class="form-label">Payment Mode *</label>
            <select class="form-select" formControlName="paymentMode">
              <option value="Cash">Cash</option>
              <option value="Card">Card</option>
              <option value="UPI">UPI</option>
              <option value="Cheque">Cheque</option>
              <option value="Bank Transfer">Bank Transfer</option>
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">Payment Date *</label>
            <input type="date" class="form-control" formControlName="paymentDate" />
          </div>

          <div class="col-md-3">
            <label class="form-label">Reference Number</label>
            <input type="text" class="form-control" formControlName="referenceNumber" placeholder="Ref/Cheque No." />
          </div>

          <div class="col-md-12">
            <label class="form-label">Remarks</label>
            <input type="text" class="form-control" formControlName="remarks" placeholder="Payment remarks" />
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button cButton color="success" type="submit" [disabled]="paymentForm.invalid || loading()">
            {{ loading() ? 'Processing...' : 'Record Payment' }}
          </button>
          <button cButton color="secondary" type="button" (click)="cancelPaymentForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Transaction History Modal -->
  <div class="card" *ngIf="showTransactions()">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Transaction History</strong>
      <button cButton size="sm" color="secondary" (click)="closeTransactions()">Close</button>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th class="text-end">Amount</th>
              <th>Reference</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of transactions">
              <td>{{ t.transactionDate | date: 'dd-MM-yyyy HH:mm' }}</td>
              <td>
                <span class="badge" 
                  [class.bg-success]="t.transactionType === 'Payment'"
                  [class.bg-danger]="t.transactionType === 'Debit'"
                  [class.bg-primary]="t.transactionType === 'Credit'">
                  {{ t.transactionType }}
                </span>
              </td>
              <td class="text-end">{{ t.amount | currency: 'INR' }}</td>
              <td>{{ t.referenceNumber || '-' }}</td>
              <td>{{ t.description }}</td>
            </tr>
            <tr *ngIf="transactions.length === 0">
              <td colspan="5" class="text-center text-muted">No transactions found</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
