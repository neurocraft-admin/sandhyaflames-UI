<div class="container-fluid mt-3">
  <!-- Header with Summary -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-2">Commercial Cylinder Customer Mapping</h5>
          <div *ngIf="summary" class="text-muted">
            <strong>Date:</strong> {{ summary.deliveryDate | date: 'dd-MM-yyyy' }} | 
            <strong>Driver:</strong> {{ summary.driverName }} | 
            <strong>Vehicle:</strong> {{ summary.vehicleNo }}
          </div>
        </div>
        <button cButton color="secondary" (click)="goBack()">
          ← Back to Deliveries
        </button>
      </div>

      <!-- Progress Summary -->
      <div class="row mt-3" *ngIf="summary">
        <div class="col-md-4">
          <div class="border rounded p-2 text-center">
            <div class="text-muted small">Total Commercial</div>
            <div class="h4 mb-0">{{ summary.totalCommercialCylinders }}</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="border rounded p-2 text-center bg-success-subtle">
            <div class="text-muted small">Mapped</div>
            <div class="h4 mb-0 text-success">{{ summary.mappedCylinders }}</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="border rounded p-2 text-center bg-warning-subtle">
            <div class="text-muted small">Unmapped</div>
            <div class="h4 mb-0 text-warning">{{ summary.unmappedCylinders }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Commercial Items -->
  <div class="card mb-3">
    <div class="card-header">
      <strong>Commercial Cylinder Products</strong>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead>
            <tr>
              <th>Product</th>
              <th>Category</th>
              <th class="text-center">Total Cylinders</th>
              <th class="text-center">Mapped</th>
              <th class="text-center">Remaining</th>
              <th class="text-end">Price</th>
              <th style="width:100px">Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of commercialItems">
              <td>{{ item.productName }}</td>
              <td>{{ item.categoryName }}</td>
              <td class="text-center">{{ item.noOfCylinders }}</td>
              <td class="text-center">
                <span class="badge bg-success">{{ item.mappedQuantity }}</span>
              </td>
              <td class="text-center">
                <span class="badge" [class.bg-warning]="item.remainingQuantity > 0" [class.bg-secondary]="item.remainingQuantity === 0">
                  {{ item.remainingQuantity }}
                </span>
              </td>
              <td class="text-end">{{ item.sellingPrice | currency: 'INR' }}</td>
              <td>
                <button cButton size="sm" color="primary" 
                  (click)="openMappingForm(item)"
                  [disabled]="item.remainingQuantity <= 0">
                  Map Customer
                </button>
              </td>
            </tr>
            <tr *ngIf="commercialItems.length === 0">
              <td colspan="7" class="text-center text-muted">
                No commercial cylinder products in this delivery
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Mapping Form -->
  <div class="card mb-3" *ngIf="showMappingForm()">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Map Cylinder to Customer</strong>
      <button cButton size="sm" color="secondary" (click)="cancelMapping()">✕</button>
    </div>
    <div class="card-body">
      <form [formGroup]="mappingForm" (ngSubmit)="submitMapping()">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Customer *</label>
            <select class="form-select" formControlName="customerId">
              <option [ngValue]="0">-- Select Customer --</option>
              <option *ngFor="let c of customers" [ngValue]="c.customerId">
                {{ c.customerName }}
              </option>
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">Quantity *</label>
            <input type="number" class="form-control" formControlName="quantity" 
              [max]="getMaxQuantity()" min="1" />
            <small class="text-muted">Max: {{ getMaxQuantity() }}</small>
          </div>

          <div class="col-md-2">
            <label class="form-label">Payment Mode *</label>
            <select class="form-select" formControlName="paymentMode" [disabled]="!!mappingForm.get('isCreditSale')?.value">
              <option value="Cash">Cash</option>
              <option value="Credit">Credit</option>
              <option value="Card">Card</option>
              <option value="UPI">UPI</option>
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">Invoice Number</label>
            <input type="text" class="form-control" formControlName="invoiceNumber" placeholder="INV-001" />
          </div>

          <div class="col-md-2 d-flex align-items-center pt-4">
            <input class="form-check-input me-2" type="checkbox" 
              formControlName="isCreditSale" 
              id="creditSaleChk"
              (change)="onCreditSaleChange()" />
            <label class="form-check-label" for="creditSaleChk">Credit Sale</label>
          </div>

          <div class="col-md-12">
            <label class="form-label">Remarks</label>
            <input type="text" class="form-control" formControlName="remarks" placeholder="Optional remarks" />
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button cButton color="primary" type="submit" [disabled]="mappingForm.invalid || loading()">
            {{ loading() ? 'Saving...' : 'Save Mapping' }}
          </button>
          <button cButton color="secondary" type="button" (click)="cancelMapping()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Existing Mappings -->
  <div class="card">
    <div class="card-header">
      <strong>Customer Mappings</strong>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead>
            <tr>
              <th>Product</th>
              <th>Customer</th>
              <th class="text-center">Quantity</th>
              <th class="text-end">Price</th>
              <th class="text-end">Total</th>
              <th>Payment</th>
              <th>Invoice</th>
              <th>Remarks</th>
              <th style="width:80px">Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let m of mappings">
              <td>{{ m.productName }}</td>
              <td>{{ m.customerName }}</td>
              <td class="text-center">{{ m.quantity }}</td>
              <td class="text-end">{{ m.sellingPrice | currency: 'INR' }}</td>
              <td class="text-end">{{ m.totalAmount | currency: 'INR' }}</td>
              <td>
                <span class="badge" 
                  [class.bg-warning]="m.isCreditSale"
                  [class.bg-success]="!m.isCreditSale">
                  {{ m.paymentMode }}
                </span>
              </td>
              <td>{{ m.invoiceNumber || '-' }}</td>
              <td>{{ m.remarks || '-' }}</td>
              <td>
                <button cButton size="sm" color="danger" (click)="deleteMapping(m.mappingId)">
                  Remove
                </button>
              </td>
            </tr>
            <tr *ngIf="mappings.length === 0">
              <td colspan="9" class="text-center text-muted">
                No customer mappings created yet
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
